name: Sayann70 Manual Clone Build
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Cleanup Space
        run: |
          sudo apt-get update
          sudo apt-get install -y bc gperf zip curl libxml2-utils build-essential git-core python3 rsync
          # GitHub runnerda joyni tozalash (Eng muhim qism)
          sudo rm -rf /usr/share/dotnet /etc/mysql /usr/local/lib/android /opt/ghc
          docker rmi $(docker images -q) 2>/dev/null || true
          
      - name: Setup Repo
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          sudo ln -sf ~/bin/repo /usr/bin/repo
          git config --global user.email "build@github.com"
          git config --global user.name "Builder"

      - name: Clone Sources Manually
        run: |
          mkdir ~/rom && cd ~/rom
          # 1. ArrowOS bazasini yuklash
          repo init -u https://github.com/ArrowOS/android_manifest.git -b arrow-13.1 --depth=1
          repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags
          
          # 2. DRAYVERLARNI QO'LDA YUKLASH (Manifestsiz)
          # Bu usul "Network failed" xatosini oldini oladi
          
          echo "Drayverlar yuklanmoqda..."
          
          # Device Tree (Branch: 13)
          git clone --depth=1 https://github.com/sayann70/device_xiaomi_spes -b 13 device/xiaomi/spes
          
          # Kernel Tree (Branch: thirteen) - Almashgan ekran uchun
          git clone --depth=1 https://github.com/sayann70/kernel_xiaomi_spes -b thirteen kernel/xiaomi/spes
          
          # Vendor Tree (Branch: thirteen) - Eng katta fayl shu, manual yuklash xavfsiz
          git clone --depth=1 https://github.com/sayann70/vendor_xiaomi_spes -b thirteen vendor/xiaomi/spes
          
          echo "Drayverlar joylandi!"

      - name: Start Build
        run: |
          cd ~/rom
          export ARROW_GAPPS=true
          export ALLOW_MISSING_DEPENDENCIES=true
          . build/envsetup.sh
          lunch arrow_spes-userdebug
          mka bacon -j$(nproc --all)
          
